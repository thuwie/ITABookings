{% extends 'layouts/base.html.twig' %}

{% block title %}ƒêƒÉng k√Ω t√†i kho·∫£n{% endblock %}

{% block body %}
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #eef2f7;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
  }

  form {
    max-width: 600px;
    width: 100%;
    background: #fff;
    padding: 25px 30px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.15);
  }

  h2 {
    text-align: center;
    color: #002b5c;
    margin-bottom: 20px;
  }

  label {
    font-weight: bold;
    color: #333;
    display: block;
    margin-bottom: 5px;
  }

  input, select, button {
    width: 100%;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
    box-sizing: border-box;
  }

  input:focus, select:focus {
    outline: none;
    border-color: #004080;
    box-shadow: 0 0 3px rgba(0, 64, 128, 0.3);
  }

  button {
    background-color: #002b5c;
    color: #fff;
    border: none;
    margin-top: 20px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    padding: 10px;
    border-radius: 5px;
    width: 100%;
  }

  button:hover {
    background-color: #004080;
  }

  .error {
    color: red;
    font-size: 13px;
    margin-top: 3px;
  }

  .success {
    text-align: center;
    color: green;
    margin-top: 10px;
    font-weight: bold;
  }

  .row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
  }

  .row .field {
    flex: 1;
  }

  .field-single {
    margin-bottom: 15px;
  }

  select {
    background-color: #fff;
  }
</style>

<form id="registerForm" method="POST" action="/register">
  <h2>ƒêƒÉng k√Ω t√†i kho·∫£n</h2>

  <!-- H·ªç v√† t√™n -->
  <div class="row">
    <div class="field">
      <label>H·ªç</label>
      <input type="text" name="last_name" placeholder="Nh·∫≠p h·ªç" required />
    </div>
    <div class="field">
      <label>T√™n</label>
      <input type="text" name="first_name" placeholder="Nh·∫≠p t√™n" required />
    </div>
  </div>

  <!-- Email v√† s·ªë ƒëi·ªán tho·∫°i -->
  <div class="row">
    <div class="field">
      <label>Email</label>
      <input type="email" name="email" placeholder="Nh·∫≠p email" required />
    </div>
    <div class="field">
      <label>S·ªë ƒëi·ªán tho·∫°i</label>
      <input type="tel" name="phone_number" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required />
    </div>
  </div>

  <!-- Gi·ªõi t√≠nh v√† ng√†y sinh -->
  <div class="row">
    <div class="field">
      <label>Gi·ªõi t√≠nh</label>
      <select name="gender" required>
        <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
        <option value="male">Nam</option>
        <option value="female">N·ªØ</option>
        <option value="other">Kh√°c</option>
      </select>
    </div>
    <div class="field">
      <label>Ng√†y sinh</label>
      <input type="date" name="date_of_birth" required />
    </div>
  </div>

  <!-- CCCD v√† ƒê·ªãa ch·ªâ -->
  <div class="row">
    <div class="field">
      <label>S·ªë CCCD</label>
      <input type="text" name="cccd" placeholder="Nh·∫≠p s·ªë CCCD" required />
    </div>
    <div class="field">
      <label>ƒê·ªãa ch·ªâ</label>
      <input type="text" name="address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" required />
    </div>
  </div>

  <!-- T·ªânh / Th√†nh ph·ªë -->
  <div class="field-single">
    <label>T·ªânh / Th√†nh ph·ªë</label>
    <select name="province_id" required>
      <option value="">-- Ch·ªçn t·ªânh / th√†nh ph·ªë --</option>
      <option value="An Giang">An Giang</option>
      <option value="B√† R·ªãa - V≈©ng T√†u">B√† R·ªãa - V≈©ng T√†u</option>
      <option value="B·∫Øc Giang">B·∫Øc Giang</option>
      <option value="B·∫Øc Ninh">B·∫Øc Ninh</option>
      <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
      <option value="TP H·ªì Ch√≠ Minh">TP H·ªì Ch√≠ Minh</option>
      <option value="H√† N·ªôi">H√† N·ªôi</option>
      <!-- B·∫°n c√≥ th·ªÉ th√™m c√°c t·ªânh kh√°c n·∫øu mu·ªën -->
    </select>
  </div>

  <!-- M·∫≠t kh·∫©u v√† x√°c nh·∫≠n -->
  <div class="row">
    <div class="field">
      <label>M·∫≠t kh·∫©u</label>
      <input type="password" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required />
    </div>
    <div class="field">
      <label>X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
      <input type="password" name="confirm_password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required />
    </div>
  </div>
  <div id="passwordError" class="error"></div>

  <input type="hidden" name="role_id" value="user" />

  <button type="submit">ƒêƒÉng k√Ω</button>
</form>

<script>
  const form = document.getElementById('registerForm');
  const errorEl = document.getElementById('passwordError');
  const successEl = document.getElementById('successMsg');

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    errorEl.textContent = '';
    successEl.textContent = '';

    const data = {
        first_name: form.first_name.value.trim(),
        last_name: form.last_name.value.trim(),
        email: form.email.value.trim(),
        phone_number: form.phone_number.value.trim(),
        password: form.password.value.trim(),
        confirm_password: form.confirm_password.value.trim(),
        gender: form.gender.value,
        date_of_birth: form.date_of_birth.value,
        cccd: form.cccd.value.trim(),
        address: form.address.value.trim(),
        province_id: form.province_id.value
    };

    const lastName  = data.last_name;
    const firstName = data.first_name;
    const phone     = data.phone_number;
    const cccd      = data.cccd;
    const password  = data.password;
    const confirm   = data.confirm_password;
    const email     = data.email;

    const nameRegex = /^[A-Za-z√Ä-·ªπ\s]+$/;
    const phoneRegex = /^[0-9]{10}$/;
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
    const cccdRegex = /^\d{12}$/;

    if (!nameRegex.test(lastName) || !nameRegex.test(firstName)) {
      errorEl.textContent = '‚ùå H·ªç v√† t√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i.';
      return;
    }

    if (!email.endsWith('@gmail.com')) {
      errorEl.textContent = '‚ùå Email ph·∫£i c√≥ ƒëu√¥i "@gmail.com".';
      return;
    }

    if (!phoneRegex.test(phone)) {
      errorEl.textContent = '‚ùå S·ªë ƒëi·ªán tho·∫°i ph·∫£i g·ªìm 10 ch·ªØ s·ªë.';
      return;
    }

    if (!cccdRegex.test(cccd)) {
      errorEl.textContent = '‚ùå CCCD ph·∫£i g·ªìm ƒë√∫ng 12 ch·ªØ s·ªë.';
      return;
    }

    if (!passwordRegex.test(password)) {
      errorEl.textContent = '‚ùå M·∫≠t kh·∫©u ph·∫£i t·ª´ 8 k√Ω t·ª±, g·ªìm ch·ªØ, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát.';
      return;
    }

    if (password !== confirm) {
      errorEl.textContent = '‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!';
      return;
    }

    try {
        const response = await fetch('{{ path("register") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            successEl.textContent = 'üéâ ƒêƒÉng k√Ω th√†nh c√¥ng! Chuy·ªÉn ƒë·∫øn ƒëƒÉng nh·∫≠p...';
            setTimeout(()=> window.location.href="{{ path('login') }}", 2000);
        } else {
            errorEl.textContent = result.error || 'ƒê√£ c√≥ l·ªói x·∫£y ra';
        }
    } catch(err) {
        errorEl.textContent = 'L·ªói m·∫°ng ho·∫∑c server';
    }
  });
</script>
{% endblock %}
